---
title: "Chapter 2"
author: "Vanilton Paulo"
date: "2025-08-15"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

# `tfb` FPC-based for US Excess Mortality

Here, we demonstrate how the constructor for functional data basis
representation `tfb_fpc` can serve as an equivalent replacement to the
SVD-based approach, to visualize and analyze cumulative all-cause excess
mortality data across 50 states and 2 territories (Puerto Rico and the
District of Columbia) in the US.

```{r setup, echo = TRUE, message = FALSE}
# ─ Packages ───────────────────
# List of required packages
packages <- c(
  "refund",
  "tidyverse",
  "tidyfun",
  "gridExtra"
)

# Install missing packages
install_if_missing <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}

# Install missing packages
invisible(lapply(packages, install_if_missing))



# Load packages
library(refund)      
library(tidyverse)   
library(tidyfun)     
library(gridExtra)

# For reproducible results
set.seed(53615)
```

```{r helpers, echo = TRUE}
# ─────── helpers ───────────────────
# Converts calendar dates to numeric values 
# The tfd requires numeric values and not as dates values.
num_grid <- function(dates, ref = min(dates)) as.numeric(dates - ref)
reference_date <- as.Date("2020-01-01")
```

## Weekly all-cause mortality data

This section demonstrates how to represent cumulative weekly all-cause
mortality data for 50 U.S states and 2 teritories (Puerto Rico and
District of Columbia) using a functional principal component (FPC)-based
basis with `tfb_fpc`.

```{r load-data, echo = TRUE, results = 'hide'}
# ──── Overview ───────────────────
data("COVID19", package = "refund") 
names(COVID19)
##  [1] "US_weekly_mort"                      "US_weekly_mort_dates"               
##  [3] "US_weekly_mort_CV19"                 "US_weekly_mort_CV19_dates"          
##  [5] "US_weekly_excess_mort_2020"          "US_weekly_excess_mort_2020_dates"   
##  [7] "US_states_names"                     "US_states_population"               
##  [9] "States_excess_mortality"             "States_excess_mortality_per_million"
## [11] "States_CV19_mortality"               "States_CV19_mortality_per_million"

# ──────── Data ─────────────────────────────────
new_states <- COVID19$US_states_names
current_date <- COVID19$US_weekly_excess_mort_2020_dates
Wd <- COVID19$States_excess_mortality_per_million  
```

```{r data-transformation-mean, include = TRUE, fig.width = 10}
# ── Data Transformation ───────────────────
# Calculate the cumulative excess mortality per million for each U.S. state and territory.
cum_mat <- t(apply(Wd, 1, cumsum))

# ──────── Turn into tfd ──────────────────────
states_cum_tf <- tfd(
  cum_mat,
  arg = num_grid(current_date),
  id  = new_states,
  var = "cum_excess"
)

# tfd[52] on (0,357) based on 52 evaluations each
# interpolation by tf_approx_linear 
# [1]: ( 0, 0.8);( 7, 8.3);(14,-6.9); ...
# [2]: ( 0,  -5);( 7,  19);(14,  26); ...
# [3]: ( 0,  -7);( 7,  -1);(14,   5); ...
# [4]: ( 0,  -7);( 7,  21);(14,  20); ...
# [5]: ( 0,   5);( 7,   7);(14,  12); ...
#     [....]   (47 not shown)
# ── grand‐mean & centered curves ─────────────────────────────────────────
# Average curve across all states
mean_curve <- mean(states_cum_tf)

# Subtracts the mean curve from each state's curve, so that we can analyze deviations from the national pattern.
centered_states_cum_tf <- scale(states_cum_tf, scale = FALSE)
# ── Plot ────────────────
#Visualize the data for each state and territory (gray solid lines) and the mean (dark red solid line).
 ggplot() +
  geom_spaghetti(aes(y = states_cum_tf),
                 colour = "grey20", alpha = 0.15) +
  geom_spaghetti(aes(y = mean_curve),
                 colour = "darkred", linewidth = 1.4) +
  scale_x_continuous(
    name = "Weeks starting January 2020",
    breaks = as.numeric(seq(reference_date, as.Date("2021-01-01"), by = "3 months") - reference_date),
    labels = format(seq(reference_date, as.Date("2021-01-01"), by = "3 months"), "%b %Y")
  ) +
  labs(
    x = "Weeks starting January 2020",
    y = "Cumulative excess deaths per million"
  ) +
  theme_classic(base_size = 13)
```

The cumulative excess deaths per million for each U.S. states and
territories (gray lines). The dark red line represents the mean
cumulative excess mortality in the US per one million residents.

The mean cumulative excess mortality curve, shown in red, represents the
average of these states and territories in the US. This allows us to see
which states’ cumulative excess curves are above or below the national
average, providing an overview of heterogeneity across states and the
two territories.

#### Display the de-meaned data

The national average curve can be subtracted from each state’s curve,
yielding centered data. The following five states are emphasized: New
Jersey (green), Louisiana (red), California (plum), Maryland (blue), and
Texas (salmon).

```{r de-meaned, include = TRUE, fig.width = 10}
centered_cum_states_tf_v2 <- tfd(
  t(apply(centered_states_cum_tf, 1, identity)),
  arg = num_grid(current_date),
  id = new_states
)
# tfd[52] on (0,357) based on 52 evaluations each
# interpolation by tf_approx_linear 
# [1]: ( 0,  -5);( 7,  -3);(14, -22); ...
# [2]: ( 0, -11);( 7,   8);(14,  11); ...
# [3]: ( 0, -13);( 7, -12);(14, -10); ...
# [4]: ( 0, -12);( 7,  10);(14,   5); ...
# [5]: ( 0,-0.6);( 7,-3.7);(14,-3.2); ...
#     [....]   (47 not shown)
# ── Plot ────────────────

emphasize <- c("New Jersey", "Louisiana", "California", "Maryland", "Texas")
emph_cols <- c("darkseagreen3", "red", "plum3", "deepskyblue4", "salmon")


# Named vector: map state names to colors
highlight_colors <- setNames(emph_cols, emphasize)

ggplot() +
  geom_spaghetti(aes(y = centered_cum_states_tf_v2),
                 colour = "grey60", alpha = 0.2,linewidth = 1) +
  geom_spaghetti(aes(
    y = centered_cum_states_tf_v2[new_states %in% emphasize],
    color = new_states[new_states %in% emphasize]  
  ) ,alpha = 2,linewidth = 1) +
  scale_color_manual(values = highlight_colors, name = "State") +
  scale_x_continuous(
    name = "Weeks starting January 2020",
    breaks = as.numeric(seq(reference_date, as.Date("2021-01-01"), by = "3 months") - reference_date),
    labels = format(seq(reference_date, as.Date("2021-01-01"), by = "3 months"), "%b %Y")
  ) +
  labs(
    x = "Weeks starting January 2020",
    y = "US states centered cumulative excess deaths/million"
  ) +
  theme_classic(base_size = 13)
```

Centered cumulative excess deaths per million, obtained after centering
the data by removing the mean at each time point. The gray lines
represent all states, while five specific states are highlighted to
emphasize their individual trends: New Jersey (green), Louisiana (red),
California (plum), Maryland (blue), and Texas (salmon).

The visualization above highlights substantial heterogeneity among
states. Some states, such as New Jersey and Louisiana, display
above-centered cumulative excess mortality. Others, such as California,
show below-centered cumulative excess mortality.

Why `svd` and `tfb_fpc` are they equivalent?

**Mathematical Equivalence**

Both methods solve the same underlying problem:

For centered data matrix $\mathbf{W}$ (mean removed):

1.  SVD approach: $\mathbf{W} = \mathbf{U} \mathbf{D} \mathbf{V}^T$
    -   $\mathbf{V}$ contains the eigenfunctions (right singular
        vectors)
2.  FPCA approach: Find eigenfunctions $\phi_k$ that maximize
    $$\text{Var}\left(\int X(t) \phi_k(t) dt\right)$$
    -   These $\phi_k$ are the same as columns of $\mathbf{V}$ from SVD

Furthermore

-   SVD's right singular vectors ($\mathbf{V}$) = FPCA's eigenfunctions
    ($\phi$)
-   SVD's left singular vectors ($\mathbf{U}$) × singular values
    ($\mathbf{D}$) = FPCA scores
-   Both decompose the same covariance structure

------------------------------------------------------------------------

#### Display the second and third eigenfunctions.

The `tfb_fpc` function is then applied to the centered data to perform
fPCA. The argument `pve = 0.995` instructs the function to select enough
principal components to explain 99.5% of the total variance in the data.

```{r eigen, include = TRUE, fig.width = 9}
# ───── Display the second and third eigenfunctions. ─────────────────────────────

# In place of the scale function, the mean curve was subtracted. 
centered_states_cum_tf <- states_cum_tf - mean_curve

covid_fpc <- tfb_fpc(centered_states_cum_tf)
# tfb[52] on (0,357) in basis representation:
#  using  5 FPCs 
# [1]: ( 0,  -5);( 7,  -4);(14, -10); ...
# [2]: ( 0,  -8);( 7,  -7);(14, -13); ...
# [3]: ( 0,   4);( 7,   5);(14,  11); ...
# [4]: ( 0,  -6);( 7,  -5);(14, -13); ...
# [5]: ( 0,-2.2);( 7,-1.2);(14,-0.9); ...
#     [....]   (47 not shown)
```

The `tf_basis` is used to extract the basis functions from a `tfb_fpc`
object

```{r basis-extract, include = TRUE, fig.width = 9}
# Extract the eigenfunctions from the fPCA result
basis_functions <- tf_basis(covid_fpc, as_tfd = TRUE)
# tfd[6] on (0,357) based on 52 evaluations each
# interpolation by tf_approx_linear 
# [1]: ( 0, 5e-16);( 7, 1e-16);(14, 1e-15); ...
# [2]: ( 0, 3e-04);( 7, 3e-04);(14, 3e-04); ...
# [3]: ( 0,-6e-04);( 7,-9e-04);(14,-2e-03); ...
# [4]: ( 0,-0.003);( 7,-0.001);(14,-0.003); ...
# [5]: ( 0,-0.004);( 7,-0.010);(14,-0.023); ...
#     [....]   (1 not shown)



ggplot() +
  geom_spaghetti(aes(y = basis_functions[2]),
                 colour = "coral", alpha = 2) +
  geom_spaghetti(aes(y = basis_functions[3]),
                 colour = "coral4", alpha = 2) +
  scale_x_continuous(
    name = "Weeks starting January 2020",
    breaks = as.numeric(seq(reference_date, as.Date("2021-01-01"), by = "3 months") - reference_date),
    labels = format(seq(reference_date, as.Date("2021-01-01"), by = "3 months"), "%b %Y")
  ) +
  labs(
    x = "Weeks starting January 2020",
    y = "Eigenfunctions"
  ) +
  theme_classic(base_size = 13)
```

The second and third eigenfunctions derived from the Functional
Principal Component Analysis (FPCA) for all-cause weekly excess US
mortality data in 2020. The second eigenfunction in light coral and
third eigenfunction in dark coral.

#### Reconstruction of the original data

```{r reconstruction, include = TRUE, fig.width = 9}
# ──────────────────── Compare the real and reconstructed data ──────────────────────

# Uses functional principal components
wsvd_fpc <- tfb_fpc(states_cum_tf, pve = .9)
# tfb[52] on (0,357) in basis representation:
#  using  2 FPCs 
# [1]: ( 0, 9);( 7,15);(14,22); ...
# [2]: ( 0, 2);( 7, 7);(14,10); ...
# [3]: ( 0, 9);( 7,15);(14,22); ...
# [4]: ( 0, 7);( 7,14);(14,22); ...
# [5]: ( 0, 4);( 7,10);(14,13); ...
#     [....]   (47 not shown)
```

#### Compare the real and reconstructed data

```{r recon-plot, include = TRUE, fig.width = 9}
# Create comparison data frame
reconstruction_df <- tibble(
  state = new_states,
  original_curve = states_cum_tf,
  # tfb_fpc reconstruction
  recon_tfb = wsvd_fpc            
) %>%
  filter(state %in% emphasize)
## # A tibble: 5 × 3
##   state                         original_curve                         recon_tfb
##   <chr>                              <tfd_reg>                         <tfb_fpc>
## 1 California [1]: ( 0, 5);( 7, 7);(14,12); ... [1]: ( 0, 4);( 7,10);(14,13); ...
## 2 Louisiana  [2]: ( 0, 6);( 7,16);(14,11); ... [2]: ( 0,11);( 7,16);(14,23); ...
## 3 Maryland   [3]: ( 0, 1);( 7, 7);(14, 7); ... [3]: ( 0, 6);( 7,11);(14,14); ...
## 4 New Jersey [4]: ( 0,11);( 7,22);(14,20); ... [4]: ( 0,11);( 7,14);(14,15); ...
## 5 Texas      [5]: ( 0, 1);( 7,11);(14,14); ... [5]: ( 0, 7);( 7,13);(14,19); ...
# ───── Plot ────────────────────────────────────

emphasize <- c("New Jersey", "Louisiana", "California", "Maryland", "Texas")
emph_cols <- c("plum3","red", "deepskyblue4","darkseagreen3", "salmon")


#Original vs tfb_fpc 
ggplot(reconstruction_df) +
  geom_spaghetti(aes(y = original_curve, color = state),
                 linewidth = 2, alpha = 0.8) +
  geom_spaghetti(aes(y = recon_tfb, color = state),
                 linewidth = 2, linetype = "dashed", alpha = 0.8) +
  scale_color_manual(values = emph_cols) +
  scale_x_continuous(
    name = "Weeks starting January 2020",
    breaks = as.numeric(seq(reference_date, as.Date("2021-01-01"), by = "3 months") - reference_date),
    labels = format(seq(reference_date, as.Date("2021-01-01"), by = "3 months"), "%b %Y")
  ) +
  labs(
    x = "Weeks starting January 2020",
    y = "Cumulative excess deaths per million",
    color = NULL
  ) +
  theme_classic(base_size = 14)

```

All-cause excess mortality (solid lines) and predicted/reconstructed
curves based on 2 FPCs (dashed lines) for five specific states: New
Jersey (green), Louisiana (red), California (plum), Maryland (blue), and
Texas (salmon).
